<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Å©„ÅÜ„Å∂„Å§ „Åã„Çã„Åü</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&display=swap');

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: none;
            background-color: #fff7ed;
            user-select: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
        }

        /* Start Screen */
        #startScreen {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.98);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        /* Header / Controls */
        .header-area {
            width: 100%;
            padding: 8px 15px;
            background: #ffedd5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #fb923c;
            height: 50px;
        }
        .reset-btn {
            background: #cbd5e1;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            border: 2px solid #94a3b8;
        }

        /* Reader Area */
        .reader-area {
            width: 100%;
            padding: 10px;
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 90px;
            border-bottom: 4px solid #fb923c;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            z-index: 20;
        }
        .reader-text {
            font-size: 1.6rem;
            color: #ea580c;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .replay-btn {
            background: #fbbf24;
            color: #78350f;
            padding: 6px 24px;
            border-radius: 20px;
            font-size: 1rem;
            box-shadow: 0 3px 0 #d97706;
            font-weight: bold;
        }
        .replay-btn:active { transform: translateY(3px); box-shadow: none; }

        /* Grid */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 600px;
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            border: 3px solid #fed7aa;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            aspect-ratio: 3/4;
        }
        .card:active { background: #ffedd5; transform: scale(0.95); }
        .card.correct { border-color: #22c55e; background: #dcfce7; transform: scale(1.05); z-index: 10; }
        .card.taken { opacity: 0; pointer-events: none; }
        .card-char { font-size: 1.8rem; color: #ea580c; position: absolute; top: 4px; right: 8px; font-weight: bold; }
        .card-img { font-size: 3.2rem; }

        /* Next Button Overlay */
        #nextOverlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.9);
            z-index: 40;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .next-btn {
            background: #22c55e;
            color: white;
            font-size: 2.2rem;
            padding: 20px 80px;
            border-radius: 999px;
            box-shadow: 0 8px 0 #15803d;
            font-weight: bold;
            animation: bounce 1s infinite;
        }
        .next-btn:active { transform: translateY(4px); box-shadow: none; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* Status Line */
        #statusLine {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #333;
            color: #4ade80;
            font-size: 10px;
            padding: 2px;
            text-align: center;
            z-index: 100;
        }
    </style>
</head>
<body>

    <a href="index.html" style="position:fixed; top:10px; left:10px; z-index:100; background:white; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; text-decoration:none; border:2px solid #fb923c; font-size:1.5rem; box-shadow:0 2px 5px rgba(0,0,0,0.2);">üè†</a>

    <div id="startScreen">
        <div class="text-7xl mb-6">üêº</div>
        <h1 class="text-4xl text-orange-600 font-bold mb-4">„Å©„ÅÜ„Å∂„Å§ „Åã„Çã„Åü</h1>
        <p class="text-gray-500 mb-8 text-sm leading-relaxed">
            „Éû„Éä„Éº„É¢„Éº„Éâ„Çí„Ç™„Éï„Å´„Åó„Å¶<br>
            Èü≥Èáè„Çí‰∏ä„Åí„Å¶ ÈÅä„Çì„Åß„Å≠
        </p>
        <button id="startBtn" class="bg-orange-500 text-white text-3xl font-bold py-5 px-16 rounded-full shadow-[0_6px_0_#c2410c] active:translate-y-1 transition-all">
            „ÅØ„Åò„ÇÅ„ÇãÔºÅ
        </button>
    </div>

    <div class="header-area">
        <div style="width: 40px;"></div> <div class="font-bold text-orange-800">„Åã„Çã„Åü</div>
        <button onclick="resetSpeech()" class="reset-btn" title="Èü≥Â£∞„Çí„Å™„Åä„Åô">üîÑ</button>
    </div>

    <div class="reader-area">
        <div id="displayText" class="reader-text">...</div>
        <button onclick="speakCurrent()" class="replay-btn">üîä „ÇÇ„ÅÜ„ÅÑ„Å£„Åã„ÅÑ</button>
    </div>

    <div id="cardGrid" class="card-grid"></div>

    <div id="nextOverlay">
        <div class="text-5xl mb-6 text-green-500 font-bold">„Åõ„ÅÑ„Åã„ÅÑÔºÅ‚≠ï</div>
        <button id="nextBtn" class="next-btn">„Å§„Åé„Å∏ ‚ñ∂</button>
    </div>

    <div id="statusLine">Ê∫ñÂÇôÂÆå‰∫Ü</div>

    <script>
        // --- Data ---
        // „Äå„Å∂„Åü„Äç„ÅØÂâäÈô§Ê∏à„Åø„ÅÆ„É™„Çπ„Éà„Åß„ÅôÔºàÂÖ®11ÊûöÔºâ
        const karutaData = [
            { char: '„ÅÑ', word: '„ÅÑ„Å¨', emoji: 'üê∂', text: '„ÅÑ„Å¨„Åå „Çè„Çì„Çè„Çì', speak: '„ÅÑ„Å¨„Åå„ÄÅ„Çè„Çì„Çè„Çì' },
            { char: '„Å≠', word: '„Å≠„Åì', emoji: 'üê±', text: '„Å≠„Åì„Åå „Å´„ÇÉ„Éº„Å´„ÇÉ„Éº', speak: '„Å≠„Åì„Åå„ÄÅ„Å´„ÇÉ„Éº„Å´„ÇÉ„Éº' },
            { char: '„ÅÜ', word: '„ÅÜ„Åï„Åé', emoji: 'üê∞', text: '„ÅÜ„Åï„Åé„Åå „Å¥„Çá„Çì„Å¥„Çá„Çì', speak: '„ÅÜ„Åï„Åé„Åå„ÄÅ„Å¥„Çá„Çì„Å¥„Çá„Çì' },
            { char: '„Å±', word: '„Å±„Çì„Å†', emoji: 'üêº', text: '„Å±„Çì„Å†„Åå „ÇÇ„Åê„ÇÇ„Åê', speak: '„Å±„Çì„Å†„Åå„ÄÅ„ÇÇ„Åê„ÇÇ„Åê' },
            { char: '„Çâ', word: '„Çâ„ÅÑ„Åä„Çì', emoji: 'ü¶Å', text: '„Çâ„ÅÑ„Åä„Çì „Åå„Åä„Éº', speak: '„Çâ„ÅÑ„Åä„Çì„ÄÅ„Åå„Åä„Éº' },
            { char: '„Åû', word: '„Åû„ÅÜ', emoji: 'üêò', text: '„Åû„ÅÜ„Åï„Çì „Å±„Åä„Éº„Çì', speak: '„Åû„ÅÜ„Åï„Çì„ÄÅ„Å±„Åä„Éº„Çì' },
            { char: '„Åï', word: '„Åï„Çã', emoji: 'üêµ', text: '„Åï„Çã„Åå „ÅÜ„Åç„Åç', speak: '„Åï„Çã„Åå„ÄÅ„ÅÜ„Åç„Åç' },
            { char: '„Åè', word: '„Åè„Åæ', emoji: 'üêª', text: '„Åè„Åæ„Åï„Çì „ÅÆ„Å£„Åó„ÅÆ„Å£„Åó', speak: '„Åè„Åæ„Åï„Çì„ÄÅ„ÅÆ„Å£„Åó„ÅÆ„Å£„Åó' },
            { char: '„Åç', word: '„Åç„Çä„Çì', emoji: 'ü¶í', text: '„Åç„Çä„Çì„Åï„Çì È¶ñ„Å™„Åå„ÅÑ', speak: '„Åç„Çä„Çì„Åï„Çì„ÄÅ„Åè„Å≥„Å™„Åå„ÅÑ' },
            { char: '„Å∫', word: '„Å∫„Çì„Åé„Çì', emoji: 'üêß', text: '„Å∫„Çì„Åé„Çì „Çà„Å°„Çà„Å°', speak: '„Å∫„Çì„Åé„Çì„ÄÅ„Çà„Å°„Çà„Å°' },
            { char: '„Åã', word: '„Åã„Åà„Çã', emoji: 'üê∏', text: '„Åã„Åà„Çã„Åå „Åë„Çç„Åë„Çç', speak: '„Åã„Åà„Çã„Åå„ÄÅ„Åë„Çç„Åë„Çç' }
        ];

        let currentTarget = null;
        let remainingCards = [];
        const synth = window.speechSynthesis;
        let voices = [];

        // --- Utils ---
        function setStatus(msg) {
            document.getElementById('statusLine').textContent = msg;
        }

        // --- Audio Context (SE) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function playSound(type) {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                const now = audioCtx.currentTime;

                if (type === 'correct') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, now);
                    osc.frequency.setValueAtTime(1760, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.5);
                    osc.start();
                    osc.stop(now + 0.5);
                } else {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start();
                    osc.stop(now + 0.3);
                }
                osc.connect(gain);
                gain.connect(audioCtx.destination);
            } catch(e) {}
        }

        // --- Speech Logic ---
        // ‚òÖ‰øÆÊ≠£ÁÇπÔºöÂ£∞„ÅÆ„É≠„Éº„ÉâÂæÖ„Å°„ÇíËøΩÂä†
        window.speechSynthesis.onvoiceschanged = function() {
            voices = window.speechSynthesis.getVoices();
        };

        function resetSpeech() {
            if (synth) {
                synth.cancel();
                setStatus('Èü≥Â£∞„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
            }
        }

        function speak(text) {
            if (!synth) {
                setStatus('„Ç®„É©„Éº: Ë™≠„Åø‰∏ä„ÅíÈùûÂØæÂøú„ÅÆÁ´ØÊú´„Åß„Åô');
                return;
            }

            // „Ç≠„É£„É≥„Çª„É´„Åó„Å¶„Ç≠„É•„Éº„Çí„ÇØ„É™„Ç¢
            synth.cancel();

            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP'; 
            uttr.rate = 0.9;
            uttr.volume = 1.0;

            // Êó•Êú¨Ë™û„ÅÆÂ£∞„ÇíÂÑ™ÂÖàÁöÑ„Å´ÈÅ∏„Å∂
            if (voices.length > 0) {
                const jpVoice = voices.find(v => v.lang.includes('ja'));
                if (jpVoice) uttr.voice = jpVoice;
            }

            uttr.onstart = () => setStatus('ÂÜçÁîü‰∏≠: ' + text);
            uttr.onend = () => setStatus('ÂÜçÁîüÂÆå‰∫Ü');
            uttr.onerror = (e) => setStatus('ÂÜçÁîü„Ç®„É©„Éº'); // „Ç®„É©„ÉºË©≥Á¥∞Ë°®Á§∫„Çí„Ç∑„É≥„Éó„É´„Å´

            synth.speak(uttr);
        }

        function speakCurrent() {
            if (currentTarget) speak(currentTarget.speak);
        }

        // --- Game Logic ---
        function initGame() {
            const grid = document.getElementById('cardGrid');
            grid.innerHTML = '';
            
            // Ë´ñÁêÜÁöÑ„Å™ÊÆã„Çä„Çí„Çª„ÉÉ„Éà
            remainingCards = [...karutaData];
            
            // ‚òÖ‰øÆÊ≠£ÁÇπÔºöÁîªÈù¢‰∏ä„ÅÆ„Ç´„Éº„ÉâÈÖçÁΩÆ„ÇÇ„É©„É≥„ÉÄ„É†„Å´„Åô„Çã
            // „Ç≥„Éî„Éº„Çí‰Ωú„Å£„Å¶„Ç∑„É£„ÉÉ„Éï„É´„Åô„Çã
            const shuffledForDisplay = [...karutaData].sort(() => Math.random() - 0.5);

            shuffledForDisplay.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.id = `card-${item.char}`;
                card.innerHTML = `
                    <div class="card-char">${item.char}</div>
                    <div class="card-img">${item.emoji}</div>
                    <div class="text-xs text-gray-400 mt-1">${item.word}</div>
                `;
                card.onclick = () => checkAnswer(item);
                grid.appendChild(card);
            });
        }

        function nextTurn() {
            document.getElementById('nextOverlay').style.display = 'none';

            if (remainingCards.length === 0) {
                document.getElementById('displayText').textContent = '„Åä„Çè„ÇäÔºÅ';
                speak('„Åä„Åó„Åæ„ÅÑ„Åß„Åô„ÄÇ„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ');
                return;
            }

            // Ê¨°„ÅÆÊ≠£Ëß£„Çí„É©„É≥„ÉÄ„É†„Å´ÈÅ∏„Å∂
            const idx = Math.floor(Math.random() * remainingCards.length);
            currentTarget = remainingCards[idx];
            
            document.getElementById('displayText').textContent = currentTarget.text;
            
            // Ë™≠„Åø‰∏ä„ÅíÈñãÂßã
            speak(currentTarget.speak);
        }

        function checkAnswer(item) {
            if (!currentTarget) return;

            if (item.char === currentTarget.char) {
                // Correct
                playSound('correct');
                const card = document.getElementById(`card-${item.char}`);
                card.classList.add('correct');
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âæå„Å´Ê∂à„Åô
                setTimeout(() => {
                    card.classList.add('taken');
                }, 500);
                
                remainingCards = remainingCards.filter(c => c.char !== currentTarget.char);
                currentTarget = null;

                // Show Next Button
                setTimeout(() => {
                    document.getElementById('nextOverlay').style.display = 'flex';
                    setStatus('Ê≠£Ëß£ÔºÅ„Å§„Åé„Å∏„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Å≠');
                }, 500);

            } else {
                // Wrong
                playSound('wrong');
                setStatus('„ÅØ„Åö„ÇåÔºÅ');
            }
        }

        // --- Event Listeners ---
        document.getElementById('startBtn').addEventListener('click', () => {
            // Audio Init
            if (!audioCtx) audioCtx = new AudioContext();
            audioCtx.resume();

            // Speech Wake-up (Â£∞„ÇíÁ¢∫ÂÆü„Å´„É≠„Éº„Éâ„Åï„Åõ„Çã)
            if (synth) {
                synth.cancel();
                voices = synth.getVoices(); // „Åì„Åì„Åß„ÇÇÂèñÂæó„Åó„Å¶„Åä„Åè
                const dummy = new SpeechSynthesisUtterance('');
                synth.speak(dummy);
            }

            document.getElementById('startScreen').style.display = 'none';
            initGame();
            
            setTimeout(() => {
                nextTurn();
            }, 500);
        });

        document.getElementById('nextBtn').addEventListener('click', nextTurn);

        // ÂàùÊúüÂåñÊôÇ„Å´Â£∞„ÇíÂèñÂæó
        window.speechSynthesis.getVoices();

    </script>
</body>
</html>
